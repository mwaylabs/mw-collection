/*! mw-collection 17-03-2014 */
!function(){"use strict";var a=function(a){return a=a||{},a.wait=angular.isDefined(a.wait)?a.wait:!0,a},b=function(b,c){return function(d){return d=a(d),b.prototype[c].apply(this,[d])}};angular.module("mwCollection",[]).run(function(a){Backbone.ajax=function(b){if(b.data){var c=JSON.parse(b.data);b.ignoreHandleResponseCodes=c.ignoreHandleResponseCodes}return b.method=b.type,a.apply(angular,[b]).then(b.success,b.error)}}).factory("MwCollection",function(){return Backbone.Collection.extend({create:b(Backbone.Collection,"create"),_filters:null,initialize:function(){this.__initialFilterValues=angular.copy(this.filterValues)},getFilters:function(){return angular.isFunction(this.filterDefinition)&&null===this._filters?this.filterDefinition():this._filters},filterValues:{},setFilters:function(a){angular.forEach(a,function(a,b){if(!_.has(this.filterValues,b))throw new Error("Filter named '"+b+"' not found, did you add it to filterValues of the model?");this.filterValues[b]=a},this)},setCustomFilters:function(a){this._filters=a},resetFilters:function(){this.filterValues=angular.copy(this.__initialFilterValues),this._filters=null},sync:function(a,b,c){if(c.params=c.params||{},"read"===a){var d=this.getFilters();d&&(c.params.filter=d),this.perPage&&this.page&&(c.params.limit=this.perPage,c.params.offset=this.page>1?this.perPage*(this.page-1):0),this._sortOrder&&(c.params.sortOrder=this._sortOrder),(this.limit||this.offset)&&(c.params.limit=this.limit,c.params.offset=this.offset),this.customUrlParams&&angular.extend(c.params,this.customUrlParams)}return Backbone.Collection.prototype.sync.apply(this,[a,b,c])},parse:function(a){return this.total=a.data.total,a.data.results},selectedModels:function(){var a=[];return angular.forEach(this.models,function(b){b.selected&&a.push(b)}),a},allSelected:function(){var a=!0;return angular.forEach(this.models,function(b){a&&(a=b.selected)}),a},toggleSelectAll:function(){this.allSelected()?this.unselectAll():this.selectAll()},selectAll:function(){angular.forEach(this.models,function(a){a.selected=!0})},unselectAll:function(){angular.forEach(this.models,function(a){a.selected=!1})},allDisabled:function(){var a=!0;return angular.forEach(this.models,function(b){a&&(a=b.selectDisabled())}),a},limit:null,offset:null,page:1,perPage:30,nextPage:function(){this.page+=1,this.fetch({remove:!1})},_sortOrder:null,setSortOrder:function(a){this._sortOrder=a},getSortOrder:function(){return this._sortOrder},customUrlParams:null})}).factory("MwModel",function(a){return Backbone.Model.extend({idAttribute:"uuid",destroy:b(Backbone.Model,"destroy"),save:b(Backbone.Model,"save"),initialize:function(){this.on("destroy",function(){this.collection.total&&this.collection.total>0&&this.collection.total--},this)},parse:function(a){return a.data&&a.data.results?a.data.results[0]:a},set:function(){var b=Backbone.Model.prototype.set.apply(this,arguments);return a.$$phase||a.$apply(),b},selected:!1,toggleSelect:function(){this.selectDisabled()||(this.selected=!this.selected)},selectDisabled:function(){return!1}})}).factory("MwCollectionFilter",function(){var a=function(a,b){return angular.isDefined(a)&&null!==a&&""!==a?b:null};return{containsString:function(b,c){return a(c,{type:"containsString",fieldName:b,contains:c})},and:function(a){return this.logOp(a,"AND")},nand:function(a){return this.logOp(a,"NAND")},or:function(a){return this.logOp(a,"OR")},logOp:function(a,b){return a=_.without(a,null),0===a.length?null:{type:"logOp",operation:b,filters:a}},"boolean":function(b,c){return a(c,{type:"boolean",fieldName:b,value:c})},like:function(b,c){return a(c,{type:"like",fieldName:b,like:c})}}})}();